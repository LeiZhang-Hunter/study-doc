#第27章 ip选项


####27.1 概述

ipv4允许在20字节首部固定部分之后以最多共40个字节的ip选项。尽管已经定义的ipv4 选项已经有10种，最常用的确实源路径选项，这些选项的访问途径是存取IP_OPTIONS套接字选项，我们将用一个使用原路径的例子展示这个访问方式。

ipv6允许在49个字节的ip首部和传输首部之间出现扩展首部。目前定义了六种不同的扩展首部。不同于ipv4，ipv6扩展首部的访问途径是函数接口，而不是强求用户理解这些首部如何呈现在ipv6分组中的真实细节。

####27.2 ipv4 选项

1）NOP:no-operation.单字节选项，典型用途是为某个后续选项落在4个字节边界上提供填充。

2）EOL:end-of-list。单字节选项，终止选项的处理。既然各个ip选项的总长度必须为4字节的倍数，因此最后一个有效选项之后可以跟0~3个EOL字节。

3）LSRR

loose source and record route 。

4）SSRR

strict source record route。

5）timestamp

6）record route

7）route alert 包含该选项的ip数据报要求所有转发路由都查看其内容

读取和设置ip选项字段使用getsockopt和setsockopt，选项为IP_OPTIONS,这两个函数第四个参数是指向某一个缓冲区，这个缓冲区的大小之所以可以比选项字段的最大长度多四个字节是由源路径的处理方式使然。除了两种原路径的选项外，其他选项在该缓冲区中的格式就是把它们至于ip数据报格式中。

使用setsockopt设置了ip选项之后，在相应套接字上发送的所有ip数据报都将包括这些选项。可以在其上设置ip选项的套接字包括tcp和udp。清除这些选项同样使用setsockopt。这是把第四个参数设置为空指针。

当调用getsockopt获取由accept创建的某个已经连接的套接字的时候，返回的是在相应监听套接字上收到的客户SYN分节所在的IP数据报中可能出现的源路径选项的逆转。源路径被TCP自动逆转顺序。因为由客户指定的是从客户到服务器的源路径，服务器却需要通过第5个参数返回值-结果长度为0.对于所有其他tcp和udp的原始套接字而言，调用getsockopt获取ip选项返回的仅仅是以前对于同一个套接字调用setsockopt设置的ip选项的一个副本。注意对于这一个原始ip套接字，输入函数总是返回包括任何ip选项在内的ip首部，因此接受ip选项总是可得。

####27.3 IPV4源路径选项（由于存在源路径欺骗已经被废除）

源路径是由ip数据报的发送者指定的一个ip地址列表。如果源路径是严格的，那么数据报必须要逐一经过所展示的列表节点。也就是说所有节点必须要前后互为邻居。如果源路径是宽松的。那么数据报必须逐一经过所列的节点，不过也可以经过未列出的在源路径中的其他节点。

####27.4 ipv6 扩展首部

ipv6存在扩展首部

1）步跳选项。如果有的话必须要紧跟40个字节的ip首部，目前没有提供应用程序使用这个选项

2）目的地址选项。目前没有定义提供应用程序使用这个选项。

3）路径首部 类似于ipv4的源地址选项

4）分片首部。该选项由ipv6数据报执行分片主动自然产生，然后最终目的主机在重组片段时候处理

5）认证首部

6）安全净何封装

基本都是由内核做处理

####27.5 ipv6目的地址选项 和 步跳选项

布跳选项和目的地址选项有相同的格式。8位的下一个首部地址字段标识跟在扩展首部之后的下一个首部。8位的首部扩展长度是本扩展首部的长度，以8个字节位单位，但是步包括第一个8字节。如果本扩展首部占据8个字节，其首部扩展长度就是0字节，如果本扩展首部占据16个字节，那么其首部扩展长度就占用一个字节，一次类推，所用的填充选项是pad1或者padN.

步跳选项首部和目的地址选项首部都容纳任意数量个体选项，其格式如27-8

个体选项的编排格式称为TLV编码，因为每个选项都呈现位它的类型、长度和值三个字段。8位的类型字段标识选项类型。除此之外，这个字段的高序指定ipv6节点不在理解本选项如何处理它。

	类型  长度  选项值
	1	  1    长度字段值

	
	00	跳过本选项，继续处理本首部。
	01	丢弃本分组。
	00  丢弃本分组，本路分组目的地址是否为一个多播地址，均发送一个ICMP参数问题类型为2的错误。
	00	丢弃本分组 并且只在本分组目的地址不是一个多播地址的前提下，发送一个ICMP参数为2的类型错误

下一个高序位指定本选项的数据在途中有没有变化

	0 选项数据在途中无变化
	0 选项数据在途中可能变化
	
####小总结：

基本不会用到这东西，大体了解就可以