第29章 数据链路访问

29.1概述 

目前大多数操作系统都提供了数据链路访问功能

能够监视由数据链路层接收的分组，比如说tcpdump这一类的程序，能够在普通计算机系统上运行，而无需使用专门的硬件设备来监视分组。如果结合使用网络接口进入混杂模式的能力，那么应用程序甚至能够监视本地电缆上流通的分组，而不仅仅是程序运行所在主机为目的的分组.

能够作为普通应用进程而不是内核的一部分运行某些程序.举例来说，RARP服务器的大多数unix版本是普通的应用进程，他们从数据链路读入RARP请求，又在数据链路上写出RARP应答

UNix上访问数据链路层的三个常用方法是BPF、SVR4的数据链路提供者接口DLPI和linux的SOCK_PACKET接口。我们首先要介绍这3个数据链路访问接口，然后讲解libpcap这个公开可得的分组捕获函数库.这个库适用于3个接口，使他们可以编写独立与操作系统提供的实际数据链路访问的接口的程序。我们通过开发一个应用程序函数库，该程序向一个名字服务器发送DNS查询，然后使用libpcap读入该名字的服务器应答，来判断它是否开启了校验和.


####29.2 BPF BSD分组过滤

####29.3 DLPI通过数据链路访问
（Data Link Provider Interface） 提供数据链路访问接口

DLPI有两种打开方式，一种是应用进程先打开统一的伪设备，再使用DLPI的DL_ATTACH_REQ往其上附接某个数据链路；另一种方式是应用进程直接打开某个网络接口设备。无论用哪种方式打开DLPI，通常需要为提高操作压入2个流，在内核中进行分组过滤的pfmod模块和应用进程缓冲数据的bufmod模块

####29.4 linux：SOCK_PACKET 和 PF_PACKET

linux 先后有两个从数据链路接收数据的方法，旧的方法是创建类型为SOCK_PACKET的套接字，这个方法可用面十分宽，不过缺少灵活性.比较新的方法是使用PF_PACKET的套接字，这个方法引入了更多过滤和性能特性.我们必须要有足够的权限才能创建这两种套接字（类似原始套接字），而且调用socket的第三个参数必须制定以太网的非0值，调用socket的第二个参数既可以是SOCK_STREAM,也可以是SOCK_RAW，标示完整的链路层分组.

从数据链路接收所有帧应如下创建套接字：

	fd = socket(PF_SOCKET,SOCK_RAW,htons(ETH_P_ALL));
	
如果只想捕获ipv4的帧，可以创建如下套接字

	fd = socket(PF_SOCKET,SOCK_RAW,htons(ETH_P_IP));
	
1.linux方法不提供内核缓冲，而且只有比较新的方法才提供内核过滤.尽管这些	套接字具有普通的套接字接收缓冲区，但是多个帧不能缓冲在一起由单个读入操作一次性传递给应用进程.这么以来势必增长从内核到应用进程复制大量数据所设计的开销

####29.5 libpcap：分组捕获函数库

libpacp是访问操作系统所提供的分组捕获机制的函数库

网址：http://www.tcpdump.org/

####29.6

libnet 函数库提供构造任意协议的分组并将其输入到网络接口中.
