#高效的多线程日志

日志:

1.诊断日志

2.交易日志

对于关键进程，日志通常要记录:

1.收到的每条内部消息的id

2.收到每条外部消息的全文

3.发出的每条消息的全文，每条消息都有全局唯一的id

4.关键内部状态的变更

每条日志都有时间戳，这样就能完整追踪到一个事件的来龙去脉

一个日志库大体可以分为前端和后端，前端是供应程序使用接口的API，后端是把日志消息写到目的地。这两个接口有可能简单到只有一个回调函数

```

void output(const char* message, int len);

```

其中message字符串是一条完整的日志消息，包括
```
1.日志级别
2.时间戳
3.源文件位置
4.线程id等
5.程序输出的具体内容
```

在多线程中前端和后端与单线程的程序没有太大区别，多个线程有各自的前端，难点在于如何将多个前端高效的传输到后端。这是一个典型的生产者和消费者问
题，要尽量做到低延迟，低cpu开销，无阻塞，对消费者而言要做到尽量大的吞吐量。

####5.1 功能需求

1.日志消息有多种级别，如：TRACE、DEBUG、INFO、WARN、ERROR、FATAL等。

2.日志消息有多种目的地，如文件、socket、smtp等。

3.日志消息格式可以配置，比如org.apache

4.可以设置运行时过滤器

对于分布式系统而言，日志目的地只有一个，本地文件，对着网络写日志是不靠谱的，通常会导致服务阻塞，内存暴涨，网络贷款飙升，也要尽量避免频繁打开
关闭描述符

日志消息格式：

日期+时间+微妙+线程+级别+正文+原文件名+行号